# HashMap小结

## 哈希表

* 核心是基于哈希值的桶和链表
* O(1)的平均查找、插入、删除时间
* 致命缺陷是哈希值的碰撞

## Java7的HashMap

* 为什么数组大小一定要是2的n次方幂

只有是2的n次方的时候，2^n-1之后才能拿到全部是1的值，这个时候按位与能够快速拿到数组下标，并且是均匀的

* Java7并发下可能会发生死锁

多线程情况下，Java7经典的数组+链表结构，在rehash下可能成环，这是CPU占100%，调用栈信息全是hashmap的get方法。而且很难重现

* 可以通过精心构造的恶意请求引发DoS

String哈希算法是公开的，tomcat请求参数通过哈希表维护，通过精细的设计，可以造出链表式的hashmap，严重影响性能

## Java8的HashMap

* 数组+链表/红黑树

* 当桶里的链表元素超过8，则转为红黑树。若小于8，则恢复为链表。由于泊松分布，桶中超过8的概率非常小

* 扩容：rehash时不用重新计算哈希值，只要看下原来计算的哈希值高一位是0还是1。且扩容时不会像Java7倒置元素
